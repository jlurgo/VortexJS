<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
        
        <title>Vendedor de buscador de libros</title>
        <link rel="stylesheet" href="../jQueryUI/css/redmond/jquery-ui-1.9.1.custom.css" />
        <style>
            #plantillas{
                display:none;
            }
        </style>
        
        <style id="estilo">
            .libro_encontrado_en_buscador{
                list-style:none;    
            }
            
            .libro_encontrado_en_buscador:hover{
                background-color: Orange;    
            }
            
            .autor_de_libro_encontrado{
                display: inline-block;
                font-weight:bold;
            }
            
            .titulo_de_libro_encontrado{
                display: inline-block;
            }
            
            .lista_de_libros_encontrados_del_buscador_de_libros{
                padding:5px;
                margin:0px;
            }
            
            .input_de_busqueda_del_buscador_de_libros
            {
                display: block;
                width:100%;
            }
        </style>
	</head>
	
	<body>		
        <div id="panel_principal">
        
        </div>	

        <div id="plantillas">
	       <li id="plantilla_libro_encontrado_en_buscador" class="libro_encontrado_en_buscador">
                <div id="autor_de_libro_encontrado" class="autor_de_libro_encontrado">
                </div>:
                <div id="titulo_de_libro_encontrado" class="titulo_de_libro_encontrado">
                </div>   
            </li>        
            <div id="plantilla_buscador_de_libros" class="buscador_de_libros">
		        <div id="controles_del_buscador_de_libros" class="controles_del_buscador_de_libros">   
                    <input type="text" id="input_de_busqueda_del_buscador_de_libros" class="input_de_busqueda_del_buscador_de_libros"/>			  
		        </div>
                <ul id="lista_de_libros_encontrados_del_buscador_de_libros" class="lista_de_libros_encontrados_del_buscador_de_libros">
		        </ul>
	        </div>      
        </div>
    </body>
    
    <script type="text/javascript" src="../linq/linq.js"></script> 
    <script type="text/javascript" src="../JQuery/jquery-1.9.1.js"></script> 
    <script type="text/javascript" src="../jQueryUI/js/jquery-ui-1.9.1.custom.js"></script>
    <script type="text/javascript" src="../VortexScripts/Vortex.js"></script>
    <script type="text/javascript" src="../VortexScripts/FiltrosYTransformaciones.js"></script>
    <script type="text/javascript" src="../VortexScripts/NodoClienteHTTP.js"></script> 
    <script type="text/javascript" src="../VortexScripts/GeneradorDeIdMensaje.js"></script> 
    <script type="text/javascript" src="../VortexScripts/NodoClienteHTTP.js"></script> 
    <script type="text/javascript" src="../VortexScripts/NodoMultiplexor.js"></script> 
    <script type="text/javascript" src="../VortexScripts/NodoPortalBidi.js"></script> 
    <script type="text/javascript" src="../VortexScripts/NodoPortalBidiMonoFiltro.js"></script> 
    <script type="text/javascript" src="../VortexScripts/NodoRouter.js"></script> 
    <script type="text/javascript" src="../VortexScripts/PataConectora.js"></script>     

    <script type="text/javascript" >            
        $(function () { 
            var router =  new NodoRouter("principal"); 
            
            var clienteHTTP = new NodoClienteHTTP('http://kfgodel.info:62626/vortex');             
            router.conectarBidireccionalmenteCon(clienteHTTP);
            
            
            var panel_principal = $('#panel_principal');
            var plantillas = $('#plantillas');
            var UI_buscador = plantillas.find('#plantilla_buscador_de_libros').clone();
            var plantilla_libro_encontrado = plantillas.find('#plantilla_libro_encontrado_en_buscador');

            var portal_ventas = new NodoPortalBidi("portal ventas");
            portal_ventas.pedirMensajes(new FiltroXClaveValor("tipoDeMensaje", "vortexComm.market.pedidoDeAplicacion"),
                                        function(){
                                            portal_ventas.enviarMensaje({tipoDeMensaje:"vortexComm.market.aplicacion",
                                                                         //aplicacion:  $('#buscadorDeLibros')[0].outerHTML,//registrarClaseNodoBuscadorDelibros.toString(),
                                                                         script: $('#buscadorDeLibros')[0].innerHTML,
                                                                         nombreApp: 'Buscador de Libros',
                                                                         cfg:{UI: UI_buscador[0].outerHTML,
                                                                              plantilla_libro: plantilla_libro_encontrado[0].outerHTML
                                                                            },
                                                                         estilo: $("#estilo")[0].outerHTML
                                                                        });
                                        }
                                    );            
            router.conectarBidireccionalmenteCon(portal_ventas);  
        });
    </script >
    
    <script id="buscadorDeLibros" type="text/javascript">
         var NodoBuscadorDeLibros = function(cfg){
            this._plantilla_libro = $(cfg.plantilla_libro);
            this._ui = $(cfg.UI);
            this.start();
        };
        
        NodoBuscadorDeLibros.prototype = {
            start: function(){
                this._router = new NodoRouter("buscador");
                this._portal = new NodoPortalBidiMonoFiltro("buscador");
                this._router.conectarBidireccionalmenteCon(this._portal);
                
                this._librosEncontrados = [];
                this._input_busqueda = this._ui.find('#input_de_busqueda_del_buscador_de_libros');
                this._panel_libros_encontrados = this._ui.find('#lista_de_libros_encontrados_del_buscador_de_libros');
                
                this._input_busqueda.change(this.nuevoCriterioDeBusqueda.bind(this));
            },
            nuevoCriterioDeBusqueda : function(){
                this.pedirLibrosPorAutor(this._input_busqueda.val());
            },
            pedirLibrosPorAutor : function(autor) {        
                this.limpiarLibrosEncontrados();
                this._portal.pedirMensajes(new FiltroAND([new FiltroXClaveValor("tipoDeMensaje", "vortexComm.biblioteca.libro"),
                                                            new FiltroXClaveValor("autor", autor)]),
                                      this.onLibroEncontrado.bind(this));  
                this._portal.enviarMensaje({tipoDeMensaje: "vortexComm.biblioteca.busquedaDeLibros", autor:autor});
            },
            limpiarLibrosEncontrados: function(){
                this._librosEncontrados = [];
                this._panel_libros_encontrados.empty();
            },
            onLibroEncontrado : function (mensaje) {      
                var libro = new NodoVistaDeLibroEnBuscador({UI: this._plantilla_libro.clone(),
                                                          idLibro: mensaje.idLibro,
                                                          autor: mensaje.autor,
                                                          titulo: mensaje.titulo,
                                                          idBiblioteca: mensaje.idBiblioteca
                                                        });
                if(this.librosEncontrados().Any(function(l){return (l._id_libro==libro._id_libro &&
                                                                    l._id_biblioteca==libro._id_biblioteca)})) return;
                this._librosEncontrados.push(libro);    
        
                this._router.conectarBidireccionalmenteCon(libro);
                libro.dibujarEn(this._panel_libros_encontrados);        
            },
            librosEncontrados : function() {
                return Enumerable.From(this._librosEncontrados);
            },    
            dibujarEn: function(panel){
                panel.append(this._ui);
            },
            conectarCon: function(un_nodo){
                this._router.conectarCon(un_nodo);   
            },
            recibirMensaje: function(un_mensaje){
                this._router.recibirMensaje(un_mensaje);    
            }   
        };
    
        var NodoVistaDeLibroEnBuscador = function(cfg){
            this._ui = $(cfg.UI);
            this._id_libro = cfg.idLibro;
            this._autor = cfg.autor;
            this._titulo = cfg.titulo;
            this._id_biblioteca = cfg.idBiblioteca;  
            this.start();
        };
    
        NodoVistaDeLibroEnBuscador.prototype = {
            start: function(){
                this._portal = new NodoPortalBidi("vista libro en buscador" + this._id_libro);
                
                this._label_autor = this._ui.find('#autor_de_libro_encontrado');
                this._label_titulo = this._ui.find('#titulo_de_libro_encontrado');
                
                this._label_autor.text(this._autor);
                this._label_titulo.text(this._titulo);
                
                this._portal.pedirMensajes(new FiltroAND([new FiltroXClaveValor("tipoDeMensaje", "vortexComm.biblioteca.libro"),
                                                          new FiltroXClaveValor("idBiblioteca", this._id_biblioteca),
                                                          new FiltroXClaveValor("idLibro", this._id_libro)]),
                                           this.actualizar.bind(this));
            },  
            actualizar: function(libro){
                this._label_autor.text(libro.autor);
                this._label_titulo.text(libro.titulo); 
            },
            dibujarEn: function(panel){
                panel.append(this._ui);
            },
            conectarCon: function(un_nodo){
                this._portal.conectarCon(un_nodo);   
            },
            recibirMensaje: function(un_mensaje){
                this._portal.recibirMensaje(un_mensaje);
            } 
        };
        
    </script>    
    
</html>