<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Prueba de vx</title>
	</head>
	
	<body>
		<button id="btn_initCache">Inicializa cache</button>
		<button id="btn_setCache">Set cache</button>
		<button id="btn_getCache">Get cache</button>
		
		<button id="btn_setRespondedor">setear respondedor</button>
		<button id="btn_sendConRespuesta">vx.send con respuesta</button>
		<button id="btn_publicarFiltros">publicar filtros a la vieja usansa</button>
		<button id="btn_enviarMensaje">enviar mensaje a la vieja usansa</button>
		
		
    </body>
    
	
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<script type="text/javascript" src="Cryptico.min.js"></script> 
	
    <script type="text/javascript" src="FiltrosYTransformaciones.js"></script>
    <script type="text/javascript" src="NodoClienteHTTP.js"></script> 
    <script type="text/javascript" src="ClonadorDeObjetos.js"></script> 
    <script type="text/javascript" src="GeneradorDeIdMensaje.js"></script> 
    <script type="text/javascript" src="NodoClienteHTTP.js"></script>  
    <script type="text/javascript" src="NodoPortalBidi.js"></script> 
    <script type="text/javascript" src="NodoPortalBidiMonoFiltro.js"></script> 
    <script type="text/javascript" src="NodoRouter.js"></script> 
    <script type="text/javascript" src="PataConectora.js"></script> 
    <script type="text/javascript" src="NodoConectorSocket.js"></script>
    <script type="text/javascript" src="socket.io.js"></script>
    <script type="text/javascript" src="Vortex.js"></script> 
    
    <script>
        $(function() {
            
			vx.start({verbose:false});

			vx.conectarPorWebSockets({
				url:'https://router-vortex.herokuapp.com' 
			});   
			
			
			
			
			var cache = function(){
				
				var _this = this;
				
				var setValor = function(clave, valor){
					
					console.log('set valorrrrrrrr');
					
					console.log(clave, valor);
					console.log(_this.dic);
					
					console.log(_this.dic[clave]);
					
					var mensaje = _this.dic[clave].filtro;
					mensaje.valor = _this.dic[clave].valor;
					
					vx.send(mensaje);
				};
				
				
				//add
				var p = arguments[0];
				
				
				//get
				if(arguments.length == 1){
					
					var _filtro;
					
					if(( arguments[0].filtro !== undefined) || ( arguments[0].clave !== undefined)){
						if( arguments[0].filtro === undefined){
							_filtro = {
								clave:  arguments[0].clave
							};
						}else{
							_filtro =  arguments[0].filtro;
						}
						
						
						this.dic[ arguments[0].clave] = {
							filtro: _filtro
						};
						
						vx.when({
							filtro: this.dic[ arguments[0].clave].filtro,
							callback: function(obj){
								_this.dic[obj.clave] = {
									valor: obj.valor
								};
							}
						});
						
						
						
						console.log('se seteo el dic en el load???????', dic)
						
						if( arguments[0].valor !== undefined){
							setValor( arguments[0].clave,  arguments[0].valor);
						}
						/////
						
						return;
						
					}
					
					return this.dic[arguments[0]];
				}
				
				//set
				if(arguments.length == 2){
					setValor(arguments[0], arguments[1]);
				}
				
				
			};
						
			
			$('#btn_setRespondedor').on('click',function(){
				//////Esto lo haria un nodo lejano que quiere responder cosas
				vx.when({
					filtro: {
						tipoDeMensaje: "test.vx.tool.pregunta"
					},
					callback: function(obj){
						
						console.log('me llegó una pregunta: ', obj);
						
						vx.send({
							tipoDeMensaje: "test.vx.tool.respuesta",
							idResponse: obj.idResponse,
							respuesta: true,
							loco: "las cosas son un flash"
						});
					}
				});
			});
			/////////
			
			
			
			$('#btn_sendConRespuesta').on('click',function(){
				/////Mensaje con respuesta
				vx.send({
					tipoDeMensaje: "test.vx.tool.pregunta",
					che: "que son las cosas?"
				},function(obj){
					console.log('respuesta a la pregunta:', obj);
				});
				//////////
			})
				
			$('#btn_publicarFiltros').on('click',function(){
				vx.pedirMensajes({
					filtro: {
						tipoDeMensaje:"test.chota"
					},
					callback: function(mensaje){
						console.log("llego: " + JSON.stringify(mensaje));
					}
				});
			});
			
			$('#btn_enviarMensaje').on('click',function(){
				vx.enviarMensaje({
					tipoDeMensaje:"test.chota",
					datun:"dale que baila"
				});
			});
				
			
			$('#btn_initCache').on('click', function(){
				///cache
				cache({
					clave: 'unalista',
					valor: ['valor', 'de', 'inicializacion', 'opcional'],
					filtro: {
						tipoDeMensaje: 'vortex.cache',
						clave: 'unalista',
						de: 'fulano'
					}
				});
				
				
				
				///cache
				cache({
					clave: 'undato',
					filtro: {
						tipoDeMensaje: 'vortex.cache',
						clave: 'unalista',
						de: 'fulano'
					}
				});
				
				
				console.log('dato recien metido en la cache', cache('unalista'));
				
				cache('unalista', ['es', 'este']);
				cache('undato', 666);
				
				console.log('una lista en la cache actualizado localmente ', cache('unalista'));
			});
			
			
			$('#btn_setCache').on('click', function(){
				event.preventDefault();
				
				
				//esto es como si fuera un foraneo el que lo hizo
				vx.send({
					tipoDeMensaje: 'vortex.cache',
					clave: 'unalista',
					valor: ['otro', 'dato', 'distinto']
				});
				//
				
				cache('undato', 777);
				
				
			});
			
			$('#btn_getCache').on('click', function(){
				event.preventDefault();
				
				console.log('una lista en la cache actualizado ', cache('unalista'));
				console.log('un dato en la cache actualizado ', cache('undato'));
			});
			
			////////////
        });
    </script>

    <script type="text/javascript" src="phonegap.js"></script>
</html>